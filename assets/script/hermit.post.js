/** 
* @name Hermit
* @version 1.6
* @create 2014-02-07
* @lastmodified 2014-09-26 10:06
* @description Hermit Plugin
* @author MuFeng (http://mufeng.me)
* @url http://mufeng.me/hermit-for-wordpress.html
**/
jQuery(document).ready(function(a){var b=["songlist","album","collect","remote"],c=[],d=function(){a("#gohermit, #wp-content-media-buttons").removeClass("selected"),a("#hermit-box").remove(),a("#wp-content-wrap").css("padding-top",54)};a("#gohermit").click(function(){0<a("#hermit-box").length?(a(this).add("#wp-content-media-buttons").removeClass("selected"),a("#hermit-box").remove()):(0<a(".wp-editor-tabs").length&&a("#wp-content-media-buttons").addClass("selected"),a(this).addClass("selected"),a(0<a(".wp-editor-tabs").length?"#wp-content-media-buttons":"#wp-content-editor-tools").after('<div id="hermit-box" class="postbox"><div id="hermit-content"><div id="hermit-tab"><ul id="hermit-tabul"><li class="hermit-tabli current">单曲</li><li class="hermit-tabli">专辑</li><li class="hermit-tabli">精选集</li><li class="hermit-tabli">远程音乐</li></ul></div><div id="hermit-body"><ul id="hermit-bodyul"><li class="hermit-bodyli current"><textarea id="hermit-song" placeholder="输入虾米歌曲地址，多个地址请回车换行"></textarea></li><li class="hermit-bodyli"><input type="text" id="hermit-album" placeholder="输入虾米专辑地址" /></li><li class="hermit-bodyli"><input type="text" id="hermit-collect" placeholder="输入虾米精选集地址" /></li><li class="hermit-bodyli">加载本地音乐中。。。</li></ul></div></div><div id="hermit-action" class="clear"><a id="hermit-delete" class="submitdelete deletion" href="javascript:;">取消</a><label for="hermit-auto"><input type="checkbox" id="hermit-auto">自动播放</label><label for="hermit-loop"><input type="checkbox" id="hermit-loop">循环播放</label><label for="hermit-unexpand"><input type="checkbox" id="hermit-unexpand">折叠播放列表</label><div id="hermit-publish" class="button button-primary">添加到文章中</div></div></div>'))}),a("#wp-content-wrap").on("click","#hermit-delete",function(){d()}),a("#wp-content-wrap").on("click",".hermit-tabli-remote li",function(){var b=a(this),d=b.attr("data-id");if(b.hasClass("selected")){var e=a.inArray(d,c);e>-1&&c.splice(e,1),b.removeClass("selected")}else b.addClass("selected"),c.push(d)}),a("#wp-content-wrap").on("click",".hermit-tabli",function(){if(!a(this).hasClass("current")){var b=a(".hermit-tabli").index(a(this));a(".hermit-tabli, .hermit-bodyli").removeClass("current"),a(".hermit-tabli:eq("+b+"), .hermit-bodyli:eq("+b+")").addClass("current"),3==b&&a(".hermit-tabli-remote").length<1&&a.ajax({url:hermit.ajax_url,data:{action:"hermit_source",type:"list"},type:"post",success:function(d){var e="";a.each(d.data,function(b,d){var f=a.inArray(d.id,c)>-1?"selected":"";e+='<li class="'+f+'" data-id="'+d.id+'">'+d.song_name+" - "+d.song_author+"</li>"}),a(".hermit-bodyli:eq("+b+")").html('<ul class="hermit-tabli-remote">'+e+"</ul>")},error:function(){alert("获取失败, 请稍候重试")}})}return!1}),a("#wp-content-wrap").on("click","#hermit-publish",function(){var e=a(".hermit-tabli").index(a(".hermit-tabli.current"));switch(b[e]){case"songlist":var e=a("#hermit-song").val(),f=[],g=/http:\/\/www.xiami.com\/song\/(\d+).*?/,e=e.split(/\r?\n/g),e=a.grep(e,function(a){return g.test(a)?!0:!1});if(0<e.length){var h=[],i=Number(a("#hermit-auto").prop("checked")),j=Number(a("#hermit-loop").prop("checked")),k=Number(a("#hermit-unexpand").prop("checked"));a.each(e,function(b,c){0>a.inArray(c,h)&&h.push(c)}),a.each(h,function(a,b){f.push(b.match(g)[1])}),e='[hermit auto="'+i+'" loop="'+j+'" unexpand="'+k+'"]songlist#:'+f.join(",")+"[/hermit]",send_to_editor(e),d()}else alert("请输入正确的虾米歌曲地址");break;case"album":var e=a("#hermit-album").val(),l=/http:\/\/www.xiami.com\/album\/(\d+).*?/,i=Number(a("#hermit-auto").prop("checked")),j=Number(a("#hermit-loop").prop("checked")),k=Number(a("#hermit-unexpand").prop("checked"));l.test(e)?(e=e.match(l)[1],send_to_editor('[hermit auto="'+i+'" loop="'+j+'" unexpand="'+k+'"]album#:'+e+"[/hermit]"),d()):alert("请输入正确的虾米专辑地址");break;case"collect":var e=a("#hermit-collect").val(),l=/http:\/\/www.xiami.com\/(song\/showcollect\/id|collect)\/(\d+).*?/,i=Number(a("#hermit-auto").prop("checked")),j=Number(a("#hermit-loop").prop("checked")),k=Number(a("#hermit-unexpand").prop("checked"));l.test(e)?(e=e.match(l)[2],send_to_editor('[hermit auto="'+i+'" loop="'+j+'" unexpand="'+k+'"]collect#:'+e+"[/hermit]"),d()):alert("请输入正确的虾米精选集地址");break;case"remote":if(c.length<1)alert("请选择本地音乐");else{var i=Number(a("#hermit-auto").prop("checked")),j=Number(a("#hermit-loop").prop("checked")),k=Number(a("#hermit-unexpand").prop("checked"));send_to_editor('[hermit auto="'+i+'" loop="'+j+'" unexpand="'+k+'"]remote#:'+c.join(",")+"[/hermit]"),d(),c=[]}}})});